/**
 * SaaS Chatbot SDK
 * Easy-to-integrate AI chatbot widget for any website
 */

(function (window) {
  'use strict';

  const AI_SERVICE_URL = 'http://localhost:3003';

  class SaaSChatbot {
    constructor() {
      this.config = {
        apiKey: null,
        chatbotId: null,
        position: 'bottom-right',
        primaryColor: '#3B82F6',
        welcomeMessage: 'Hello! How can I help you today?',
        placeholder: 'Type your message...',
      };

      this.isOpen = false;
      this.sessionId = this.generateSessionId();
      this.messages = [];
      this.widget = null;
    }

    /**
     * Initialize the chatbot
     */
    init(options) {
      if (!options.apiKey || !options.chatbotId) {
        console.error('SaaS Chatbot: apiKey and chatbotId are required');
        return;
      }

      this.config = { ...this.config, ...options };
      this.injectStyles();
      this.createWidget();
      this.addEventListeners();
    }

    /**
     * Generate unique session ID
     */
    generateSessionId() {
      return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    /**
     * Inject CSS styles
     */
    injectStyles() {
      const styles = `
        .saas-chatbot-button {
          position: fixed;
          ${this.config.position.includes('right') ? 'right: 20px;' : 'left: 20px;'}
          ${this.config.position.includes('bottom') ? 'bottom: 20px;' : 'top: 20px;'}
          width: 60px;
          height: 60px;
          border-radius: 50%;
          background: ${this.config.primaryColor};
          color: white;
          border: none;
          cursor: pointer;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 24px;
          z-index: 9998;
          transition: all 0.3s;
        }

        .saas-chatbot-button:hover {
          transform: scale(1.1);
          box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .saas-chatbot-window {
          position: fixed;
          ${this.config.position.includes('right') ? 'right: 20px;' : 'left: 20px;'}
          ${this.config.position.includes('bottom') ? 'bottom: 90px;' : 'top: 90px;'}
          width: 380px;
          height: 600px;
          max-height: calc(100vh - 120px);
          background: white;
          border-radius: 12px;
          box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
          display: none;
          flex-direction: column;
          z-index: 9999;
          overflow: hidden;
        }

        .saas-chatbot-window.open {
          display: flex;
        }

        .saas-chatbot-header {
          background: ${this.config.primaryColor};
          color: white;
          padding: 16px 20px;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .saas-chatbot-header h3 {
          margin: 0;
          font-size: 18px;
          font-weight: 600;
        }

        .saas-chatbot-close {
          background: none;
          border: none;
          color: white;
          font-size: 24px;
          cursor: pointer;
          padding: 0;
          width: 30px;
          height: 30px;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .saas-chatbot-messages {
          flex: 1;
          overflow-y: auto;
          padding: 20px;
          background: #F9FAFB;
        }

        .saas-chatbot-message {
          margin-bottom: 16px;
          display: flex;
          gap: 8px;
        }

        .saas-chatbot-message.user {
          flex-direction: row-reverse;
        }

        .saas-chatbot-message-content {
          max-width: 70%;
          padding: 12px 16px;
          border-radius: 12px;
          font-size: 14px;
          line-height: 1.5;
        }

        .saas-chatbot-message.bot .saas-chatbot-message-content {
          background: white;
          color: #1F2937;
          border: 1px solid #E5E7EB;
        }

        .saas-chatbot-message.user .saas-chatbot-message-content {
          background: ${this.config.primaryColor};
          color: white;
        }

        .saas-chatbot-typing {
          display: flex;
          gap: 4px;
          padding: 12px 16px;
          background: white;
          border-radius: 12px;
          width: fit-content;
          border: 1px solid #E5E7EB;
        }

        .saas-chatbot-typing span {
          width: 8px;
          height: 8px;
          border-radius: 50%;
          background: #9CA3AF;
          animation: typing 1.4s infinite;
        }

        .saas-chatbot-typing span:nth-child(2) {
          animation-delay: 0.2s;
        }

        .saas-chatbot-typing span:nth-child(3) {
          animation-delay: 0.4s;
        }

        @keyframes typing {
          0%, 60%, 100% {
            transform: translateY(0);
          }
          30% {
            transform: translateY(-10px);
          }
        }

        .saas-chatbot-input-container {
          padding: 16px;
          background: white;
          border-top: 1px solid #E5E7EB;
          display: flex;
          gap: 8px;
        }

        .saas-chatbot-input {
          flex: 1;
          padding: 12px 16px;
          border: 1px solid #E5E7EB;
          border-radius: 8px;
          font-size: 14px;
          outline: none;
        }

        .saas-chatbot-input:focus {
          border-color: ${this.config.primaryColor};
        }

        .saas-chatbot-send {
          padding: 12px 20px;
          background: ${this.config.primaryColor};
          color: white;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          font-weight: 600;
          transition: all 0.3s;
        }

        .saas-chatbot-send:hover {
          opacity: 0.9;
        }

        .saas-chatbot-send:disabled {
          opacity: 0.5;
          cursor: not-allowed;
        }

        @media (max-width: 480px) {
          .saas-chatbot-window {
            width: calc(100vw - 40px);
            height: calc(100vh - 120px);
          }
        }
      `;

      const styleSheet = document.createElement('style');
      styleSheet.textContent = styles;
      document.head.appendChild(styleSheet);
    }

    /**
     * Create widget HTML
     */
    createWidget() {
      const container = document.createElement('div');
      container.innerHTML = `
        <button class="saas-chatbot-button" id="saas-chatbot-toggle">
          ðŸ’¬
        </button>
        
        <div class="saas-chatbot-window" id="saas-chatbot-window">
          <div class="saas-chatbot-header">
            <h3>Chat with us</h3>
            <button class="saas-chatbot-close" id="saas-chatbot-close">Ã—</button>
          </div>
          
          <div class="saas-chatbot-messages" id="saas-chatbot-messages">
            <div class="saas-chatbot-message bot">
              <div class="saas-chatbot-message-content">
                ${this.config.welcomeMessage}
              </div>
            </div>
          </div>
          
          <div class="saas-chatbot-input-container">
            <input 
              type="text" 
              class="saas-chatbot-input" 
              id="saas-chatbot-input"
              placeholder="${this.config.placeholder}"
            />
            <button class="saas-chatbot-send" id="saas-chatbot-send">Send</button>
          </div>
        </div>
      `;

      document.body.appendChild(container);
      this.widget = {
        toggle: document.getElementById('saas-chatbot-toggle'),
        window: document.getElementById('saas-chatbot-window'),
        close: document.getElementById('saas-chatbot-close'),
        messages: document.getElementById('saas-chatbot-messages'),
        input: document.getElementById('saas-chatbot-input'),
        send: document.getElementById('saas-chatbot-send'),
      };
    }

    /**
     * Add event listeners
     */
    addEventListeners() {
      this.widget.toggle.addEventListener('click', () => this.toggle());
      this.widget.close.addEventListener('click', () => this.close());
      this.widget.send.addEventListener('click', () => this.sendMessage());
      this.widget.input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') this.sendMessage();
      });
    }

    /**
     * Toggle chatbot window
     */
    toggle() {
      this.isOpen = !this.isOpen;
      this.widget.window.classList.toggle('open', this.isOpen);
      if (this.isOpen) {
        this.widget.input.focus();
      }
    }

    /**
     * Open chatbot
     */
    open() {
      this.isOpen = true;
      this.widget.window.classList.add('open');
      this.widget.input.focus();
    }

    /**
     * Close chatbot
     */
    close() {
      this.isOpen = false;
      this.widget.window.classList.remove('open');
    }

    /**
     * Send message
     */
    async sendMessage() {
      const message = this.widget.input.value.trim();
      if (!message) return;

      // Add user message to UI
      this.addMessage(message, 'user');
      this.widget.input.value = '';

      // Show typing indicator
      this.showTyping();

      try {
        // Send to AI service
        const response = await fetch(`${AI_SERVICE_URL}/api/ai/chat`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-API-Key': this.config.apiKey,
          },
          body: JSON.stringify({
            message,
            sessionId: this.sessionId,
            chatbotId: this.config.chatbotId,
          }),
        });

        const data = await response.json();

        // Remove typing indicator
        this.hideTyping();

        if (data.success) {
          this.addMessage(data.data.message, 'bot');
        } else {
          this.addMessage('Sorry, I encountered an error. Please try again.', 'bot');
        }
      } catch (error) {
        this.hideTyping();
        this.addMessage('Sorry, I\'m having trouble connecting. Please try again later.', 'bot');
        console.error('Chatbot error:', error);
      }
    }

    /**
     * Add message to UI
     */
    addMessage(text, sender) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `saas-chatbot-message ${sender}`;
      messageDiv.innerHTML = `
        <div class="saas-chatbot-message-content">${this.escapeHtml(text)}</div>
      `;

      this.widget.messages.appendChild(messageDiv);
      this.widget.messages.scrollTop = this.widget.messages.scrollHeight;
    }

    /**
     * Show typing indicator
     */
    showTyping() {
      const typingDiv = document.createElement('div');
      typingDiv.id = 'saas-chatbot-typing-indicator';
      typingDiv.className = 'saas-chatbot-typing';
      typingDiv.innerHTML = '<span></span><span></span><span></span>';
      this.widget.messages.appendChild(typingDiv);
      this.widget.messages.scrollTop = this.widget.messages.scrollHeight;
    }

    /**
     * Hide typing indicator
     */
    hideTyping() {
      const typingDiv = document.getElementById('saas-chatbot-typing-indicator');
      if (typingDiv) {
        typingDiv.remove();
      }
    }

    /**
     * Escape HTML to prevent XSS
     */
    escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  }

  // Expose to window
  window.SaaSChatbot = new SaaSChatbot();

})(window);
